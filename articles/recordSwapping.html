<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Targeted Record Swapping â€¢ sdcMicro</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Targeted Record Swapping">
<meta property="og:description" content="sdcMicro">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">sdcMicro</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">5.7.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/sdcMicro.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/recordSwapping.html">Targeted Record Swapping</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/sdcTools/sdcMicro/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Targeted Record Swapping</h1>
                        <h4 data-toc-skip class="author">Johannes Gussenbauer</h4>
            
            <h4 data-toc-skip class="date">2022-10-10</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/sdcTools/sdcMicro/blob/HEAD/vignettes/recordSwapping.Rmd" class="external-link"><code>vignettes/recordSwapping.Rmd</code></a></small>
      <div class="hidden name"><code>recordSwapping.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>This is the vignette for the R-Package <em>recordSwapping</em>, which can be used to apply the record swapping algorithm to a micro data set. The implementation of the procedure was done purely in C++ and is based on the SAS code on targeted record swapping from ONS (<a href="https://ec.europa.eu/eurostat/cros/content/2-record-swapping_en" class="external-link uri">https://ec.europa.eu/eurostat/cros/content/2-record-swapping_en</a>). There are, however, substantial differences between the SAS and C++ Code. Some of these differences are the result of improving the run-time for the C++ implementation. In the next section, the differences between the 2 implementations are presented further. The R-Package is just as a front end to easily call the procedures and for testing purposes.</p>
</div>
<div class="section level2">
<h2 id="functionality">Functionality<a class="anchor" aria-label="anchor" href="#functionality"></a>
</h2>
<p>The targeted record swapping can be applied with the function <code><a href="../reference/recordSwap.html">recordSwap()</a></code>. All other functions in the package are called from inside <code><a href="../reference/recordSwap.html">recordSwap()</a></code> and are only exported for testing purposes. The function has the following arguments:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>recordSwap<span class="op">(</span><span class="bu">std::</span>vector<span class="op">&lt;</span> <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> <span class="op">&gt;</span> data<span class="op">,</span> <span class="dt">int</span> hid<span class="op">,</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>                                           <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> hierarchy<span class="op">,</span> </span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>                                           <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;&gt;</span> similar<span class="op">,</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>                                           <span class="dt">double</span> swaprate<span class="op">,</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>                                           <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&gt;</span> risk<span class="op">,</span> <span class="dt">double</span> risk_threshold<span class="op">,</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>                                           <span class="dt">int</span> k_anonymity<span class="op">,</span> <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> risk_variables<span class="op">,</span>  </span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>                                           <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> carry_along<span class="op">,</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>                                           <span class="dt">int</span> <span class="op">&amp;</span>count_swapped_records<span class="op">,</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>                                           <span class="dt">int</span> <span class="op">&amp;</span>count_swapped_hid<span class="op">,</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>                                           <span class="bu">std::</span>string<span class="op"> </span>log_file_name<span class="op">,</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>                                           <span class="dt">int</span> seed <span class="op">=</span> <span class="dv">123456</span><span class="op">)</span></span></code></pre></div>
<ul>
<li>
<strong>data</strong> micro data containing ONLY integer values, rectangular table format.</li>
<li>
<strong>hid</strong> column index in  which refers to the household identifier.</li>
<li>
<strong>hierarchy</strong> column indices of variables in  which refer to the geographic hierarchy in the micro data set. For instance county &gt; municipality &gt; district.</li>
<li>
<strong>similar</strong> vector of vector containing the similarity profiles that are sets of variables in  which should be considered when swapping households.  corresponds to the first set similarity variables,  to the second set and so on.</li>
<li>
<strong>swaprate</strong> double between 0 and 1 defining the proportion of households which should be swapped, see details for more explanations</li>
<li>
<strong>risk</strong> vector of vector containing the risk of each individual for each hierarchy level. <code>risk[0]</code> corresponds to the risks of the first record for all hierarchy levels, <code>risk[1]</code> for the second record and so on. Should be ignored, for now, it is not fully tested yet.</li>
<li>
<strong>risk_threshold</strong> risk threshold, which determines if a record has to be swapped and over which hierarchy level. This overwrites k_anonymity. Should be ignored, for now, it is not fully tested yet.</li>
<li>
<strong>k_anonymity</strong> integer defining the threshold of high risk households (k-anonymity). A record is not at risk if <code>k_anonymity &gt; counts</code>.</li>
<li>
<strong>risk_variables</strong> column indices of variables in  which will be considered for estimating the risk. This is only used if <code>risk</code> was not supplied.</li>
<li>
<strong>carry_along</strong> column indices of variables in  which are additionally swapped. These variables do not interfere with the procedure of finding a record to swap with. This parameter is only used at the end of the procedure when swapping the hierarchies. We note that the variables to be used as <code>carry_along</code> should be at household level. In case it is detected that they are at individual level (different values within <code>hid</code>), a warning is given because unexpected results may occur since the first observed value within the Household for any variable is used for all members in the swapped household.</li>
<li>
<strong>count_swapped_records</strong>, <strong>count_swapped_hid</strong> count number of households and records swapped</li>
<li>
<strong>log_file_name</strong> path for writing a log file. The log file contains a list of household IDs (<code>hid</code>) that could not have been swapped and is only created if any such households exist.</li>
<li>
<strong>seed</strong> integer defining the seed for the random number generator, for reproducibility.</li>
</ul>
<p><strong>IMPORTANT</strong>: The argument <code>data</code> contains the micro data and can be understood as a vector of vectors. Inside the function, <code>data</code> is expected to contain each column of the input data as <code>std::vector&lt;int&gt;</code> which are then again stored in an <code>std::vector&lt; std::vector&lt;int&gt; &gt;</code>. So <code>data[0]</code> addresses variables of the first record and <code>data[0][0]</code> the first column of the first record. The same logic hold for the argument <code>risk</code>.</p>
<div class="section level3">
<h3 id="some-differences-to-sas-code">Some differences to SAS-Code<a class="anchor" aria-label="anchor" href="#some-differences-to-sas-code"></a>
</h3>
<div class="section level4">
<h4 id="risk-definition">Risk definition<a class="anchor" aria-label="anchor" href="#risk-definition"></a>
</h4>
<ul>
<li>
<strong>C++-Code</strong>: Risk is calculated using counts over the geographic hierarchies (<code>hierarchy</code>) and the combination of all risk variables.</li>
<li>
<strong>SAS-Code</strong>: Risk is calculated using counts for each geographic hierarchy (<code>hierarchy</code>) and risk variable separately. These risks are then combined to produce a single risk value for each record.</li>
</ul>
</div>
<div class="section level4">
<h4 id="sampling-probability">Sampling probability<a class="anchor" aria-label="anchor" href="#sampling-probability"></a>
</h4>
<ul>
<li>
<strong>C++-Code</strong>: Sampling probability <span class="math inline">\(p_{y,h}\)</span> for household <span class="math inline">\(y\)</span> at the geographic hierarchy <span class="math inline">\(h\)</span> is derived from the risks <span class="math inline">\(r_{i,h}\)</span> of all individuals living in the same household. The risk <span class="math inline">\(r_{i,h}\)</span> for each individual <span class="math inline">\(i\)</span> in geographic hierarchy (<span class="math inline">\(h\)</span>) is currently estimated through the k-anonymity rule. <span class="math inline">\(r_{i,h}\)</span> is then defined as</li>
</ul>
<p><span class="math display">\[
r_{i,h} = (\sum\limits_{j=1}^{N_{g_1}}1[v_{1(i)}=v_{1(j)} \land ... \land v_{p(i)}=v_{p(j)}])^{-1} \quad ,
\]</span></p>
<p>with <span class="math inline">\(v_1,\ldots,v_p\)</span> as a set of risk variables, <span class="math inline">\(N_{g_1}\)</span> as the number of persons living in region <span class="math inline">\(g_1\)</span> and <span class="math inline">\(1[...]\)</span> as the indicator function. <span class="math inline">\(1[v_{1(i)}=v_{1(j)} \land ... \land v_{p(i)}=v_{p(j)}]\)</span> is 1 if individual <span class="math inline">\(j\)</span> as the same values for risk variables <span class="math inline">\(v_1,\ldots,v_p\)</span> as individual <span class="math inline">\(i\)</span> and is 0 otherwise. Casually speaking</p>
<p><span class="math display">\[
r_{i,h} \sim \frac{1}{counts} \quad .
\]</span></p>
<p>The sampling probability for household <span class="math inline">\(y\)</span>, <span class="math inline">\(p_{y,h}\)</span> in hierarchy <span class="math inline">\(h\)</span>, is then defined by the maximum of risk across all household member</p>
<p><span class="math display">\[
p_{y,h} = \max_{i\text{ in household }y}(r_{i,h}) \quad .
\]</span> This sampling probability is used for selecting households for swapping as well as donor households.</p>
<ul>
<li>
<strong>SAS-Code</strong>: Sampling probability is derived from multiple factors.</li>
</ul>
<p><span class="math display">\[
p_i = \begin{cases}
0.999 \quad \text{for low risk household} \\
\frac{b\cdot N_{high}}{SA\cdot c-b\cdot c} \quad \text{for }b&gt;0 \\
\frac{0.2\cdot N_{high}}{SA\cdot c-0.2\cdot c} \quad \text{for }b=0 \\
\frac{0.1\cdot N_{high}}{SA\cdot c-0.1\cdot c} \quad \text{for }b&lt;0
\end{cases}
\]</span> where <span class="math display">\[
b = SA - N_{high}\\
c = N_{netto} - N_{high}
\]</span> with <span class="math inline">\(SA\)</span> as the sample size, <span class="math inline">\(N_{high}\)</span> as the number of high risk households in the geographic area and <span class="math inline">\(N_{netto}\)</span> the number of non-imputed records in the geographic area.</p>
</div>
<div class="section level4">
<h4 id="swapping-records">Swapping Records<a class="anchor" aria-label="anchor" href="#swapping-records"></a>
</h4>
<ul>
<li>
<strong>C++-Code</strong>: Swaps are made in every hierarchy level and records which do not fulfil the k-anonymity are swapped. The donor set of records to be swapped with is always made out of every record which does not belong to the same geographic area as the swapped households. At the lowest hierarchy level, an additional number of households is swapped such that the proportion of households swapped is equal to the number in <code>swaprate</code>. If the proportion of already swapped households succeeds these values then records that do not fulfil the k-anonymity are also swapped.</li>
</ul>
<div class="figure">
<img src="diagram.png" style="width:100.0%" alt=""><p class="caption">Example for swapping households. The number represents the number of high risk households at each hierarchy level.</p>
</div>
<p>Figure 1 displays an example with hierarchy levels NUTS1 &gt; NUTS2 &gt; NUTTS3 where the numbers of high risk households are displayed at the end of the edges. For instance, in the first NUTS1 region, there are 5 high risk households that will be swapped with households from other NUTS1 regions. In the first NUTS2 region, there are 10 high risk households that will be swapped with households that are not in the same NUTS2 region. At the lowest level, the NUTS3 regions, the number of swaps, <span class="math inline">\(n_{swaps}\)</span> for the first district is defined by</p>
<p><span class="math display">\[
n_{swaps} = 2 + Rest\\
Rest = \max(0,N\cdot s - n_{already}) 
\]</span> with <span class="math inline">\(N\)</span> as the number of households in the district, <span class="math inline">\(n_{already}\)</span> as the number of already swapped households in the district and <span class="math inline">\(s\)</span> as the swap rate.</p>
<ul>
<li>
<strong>SAS-Code</strong> Swaps are made in every hierarchy level and depending on the sampling probability, high risk households are more likely to be swapped than low risk households, but they are not mandatorily swapped. The number of swappes in each hierarchy level is defined by the number of high risk records and the total number of records in the geographic area. For instance, having the geographic hierarchy county &gt; municipality &gt; district, the number of Swaps in the municipality <span class="math inline">\(m\)</span> of county <span class="math inline">\(n\)</span> is defined by</li>
</ul>
<p><span class="math display">\[
SWAP_m = \frac{SIZE_m+RISK_m}{2}
\]</span> where <span class="math inline">\(SIZE_m\)</span> can be derived by using the reciprocal number of households of each municipality in county <span class="math inline">\(n\)</span>.</p>
<p><span class="math display">\[
SIZE_m = \frac{N_m^{-1}}{\sum_iN_i^{-1}}\cdot sN_n
\]</span> with <span class="math inline">\(N_m\)</span> as the number of households in municipality <span class="math inline">\(m\)</span>, <span class="math inline">\(s\)</span> the global swaprate and <span class="math inline">\(N_n\)</span> as the number of households in county <span class="math inline">\(n\)</span>. <span class="math inline">\(RISK_m\)</span> can be derived using the proportion of high risk households in each municipality</p>
<p><span class="math display">\[
RISK_m = \frac{H_m}{\sum_iH_i}\cdot sN_n
\]</span></p>
<p>with <span class="math inline">\(H_m\)</span> as the proportion of high risk households in municipality <span class="math inline">\(m\)</span>.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="application">Application<a class="anchor" aria-label="anchor" href="#application"></a>
</h2>
<p>The package was tested on randomly generated data, which contained 5 geographic levels and some other sociodemographic variables.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/sdcTools/sdcMicro" class="external-link">sdcMicro</a></span><span class="op">)</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/recordSwap.html">createDat</a></span><span class="op">(</span>N<span class="op">=</span><span class="fl">100000</span><span class="op">)</span></span>
<span><span class="va">dat</span></span></code></pre></div>
<pre><code><span><span class="co">##         nuts1 nuts2 nuts3  lau2    hid hsize ageGroup gender national htype</span></span>
<span><span class="co">##      1:     3    34  3405 34051      1     5        4      2        3     6</span></span>
<span><span class="co">##      2:     3    34  3405 34051      1     5        4      1        2     6</span></span>
<span><span class="co">##      3:     3    34  3405 34051      1     5        6      1        3     6</span></span>
<span><span class="co">##      4:     3    34  3405 34051      1     5        3      2        1     6</span></span>
<span><span class="co">##      5:     3    34  3405 34051      1     5        4      2        3     6</span></span>
<span><span class="co">##     ---                                                                    </span></span>
<span><span class="co">## 348831:     3    35  3508 35085 100000     6        6      1        1     3</span></span>
<span><span class="co">## 348832:     3    35  3508 35085 100000     6        3      2        1     3</span></span>
<span><span class="co">## 348833:     3    35  3508 35085 100000     6        7      1        4     3</span></span>
<span><span class="co">## 348834:     3    35  3508 35085 100000     6        3      1        5     3</span></span>
<span><span class="co">## 348835:     3    35  3508 35085 100000     6        2      1        5     3</span></span>
<span><span class="co">##         hincome</span></span>
<span><span class="co">##      1:       6</span></span>
<span><span class="co">##      2:       6</span></span>
<span><span class="co">##      3:       6</span></span>
<span><span class="co">##      4:       6</span></span>
<span><span class="co">##      5:       6</span></span>
<span><span class="co">##     ---        </span></span>
<span><span class="co">## 348831:       6</span></span>
<span><span class="co">## 348832:       6</span></span>
<span><span class="co">## 348833:       6</span></span>
<span><span class="co">## 348834:       6</span></span>
<span><span class="co">## 348835:       6</span></span></code></pre>
<p>Applying the record swapping to dat could look like this</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hierarchy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"nuts1"</span>,<span class="st">"nuts2"</span><span class="op">)</span></span>
<span><span class="va">risk_variables</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hincome"</span>,<span class="st">"ageGroup"</span>,<span class="st">"gender"</span><span class="op">)</span></span>
<span><span class="va">k_anonymity</span> <span class="op">&lt;-</span> <span class="fl">3</span></span>
<span><span class="va">swaprate</span> <span class="op">&lt;-</span> <span class="fl">.05</span></span>
<span><span class="va">hid</span> <span class="op">&lt;-</span> <span class="st">"hid"</span></span>
<span><span class="va">similar</span> <span class="op">&lt;-</span> <span class="st">"hsize"</span></span>
<span></span>
<span><span class="va">dat_swapped</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/recordSwap.html">recordSwap</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">dat</span>, hid <span class="op">=</span> <span class="va">hid</span>,</span>
<span>                          hierarchy <span class="op">=</span> <span class="va">hierarchy</span>,</span>
<span>                          similar <span class="op">=</span> <span class="va">similar</span>,</span>
<span>                          risk_variables <span class="op">=</span> <span class="va">risk_variables</span>,</span>
<span>                          k_anonymity <span class="op">=</span> <span class="va">k_anonymity</span>,</span>
<span>                          swaprate <span class="op">=</span> <span class="va">swaprate</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Recordswapping was successful!</span></span></code></pre>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat_swapped</span></span></code></pre></div>
<p>Here the procedure was applied to <code>dat</code></p>
<ul>
<li>using every hierarchy level, <code>nuts1</code> and <code>nuts2</code>
</li>
<li>using <code>hsize</code> as the similarity variable (so only households with the same household size are swapped)</li>
<li>using <code>hIncome</code>, <code>ageGroup</code>, <code>gender</code> as risk variables</li>
<li>setting the k-anonymity rule to 3</li>
<li>setting the swaprate to 0.05</li>
</ul>
<p>If <code>k_anonymity &lt;- 0</code> only the swaprate is considered. Then at most <code>th*100</code>% of the households are swapped. If the sample is very small, the actual number of swaps can be smaller, however, this can only happen if some regions have a very small number of households, e.g.Â 1,2,3,â€¦</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">k_anonymity</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">swaprate</span> <span class="op">&lt;-</span> <span class="fl">.05</span></span>
<span><span class="va">dat_swapped</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/recordSwap.html">recordSwap</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">dat</span>, hid <span class="op">=</span> <span class="va">hid</span>,</span>
<span>                          hierarchy <span class="op">=</span> <span class="va">hierarchy</span>,</span>
<span>                          similar <span class="op">=</span> <span class="va">similar</span>,</span>
<span>                          risk_variables <span class="op">=</span> <span class="va">risk_variables</span>,</span>
<span>                          k_anonymity <span class="op">=</span> <span class="va">k_anonymity</span>,</span>
<span>                          swaprate <span class="op">=</span> <span class="va">swaprate</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Recordswapping was successful!</span></span></code></pre>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat_swapped</span></span></code></pre></div>
<p>Comparing number of swapped households</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat_compare</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">dat</span><span class="op">[</span>,<span class="fu">.</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">nuts1</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="va">nuts2</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,by<span class="op">=</span><span class="va">hid</span><span class="op">]</span>,</span>
<span>                     <span class="va">dat_swapped</span><span class="op">[</span>,<span class="fu">.</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">nuts1</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="va">nuts2</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,by<span class="op">=</span><span class="va">hid</span><span class="op">]</span>,by<span class="op">=</span><span class="st">"hid"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># number of swapped households</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">dat_compare</span><span class="op">[</span><span class="va">V1.x</span><span class="op">!=</span><span class="va">V1.y</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 5000</span></span></code></pre>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># swaprate times number of households in data</span></span>
<span><span class="va">dat</span><span class="op">[</span>,<span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/duplicated.html" class="external-link">uniqueN</a></span><span class="op">(</span><span class="va">hid</span><span class="op">)</span><span class="op">]</span><span class="op">*</span><span class="va">swaprate</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 5000</span></span></code></pre>
<div class="section level3">
<h3 id="supplying-index-vectors">Supplying index vectors<a class="anchor" aria-label="anchor" href="#supplying-index-vectors"></a>
</h3>
<p>Instead of column names, index vectors can be supplied for parameters <code>hid</code>, <code>hierarchy</code>, <code>similar</code> and <code>risk_variables</code>.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hierarchy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span> <span class="co"># ~ c("nuts1","nuts2")</span></span>
<span><span class="va">risk_variables</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">11</span>,<span class="fl">7</span>,<span class="fl">8</span><span class="op">)</span> <span class="co"># ~ c("hincome","ageGroup","gender")</span></span>
<span><span class="va">hid</span> <span class="op">&lt;-</span> <span class="fl">5</span> <span class="co"># ~ "hid"</span></span>
<span><span class="va">similar</span> <span class="op">&lt;-</span> <span class="fl">6</span> <span class="co"># ~ "hsize"</span></span>
<span></span>
<span><span class="va">dat_swapped</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/recordSwap.html">recordSwap</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">dat</span>, hid <span class="op">=</span> <span class="va">hid</span>,</span>
<span>                          hierarchy <span class="op">=</span> <span class="va">hierarchy</span>,</span>
<span>                          similar <span class="op">=</span> <span class="va">similar</span>,</span>
<span>                          risk_variables <span class="op">=</span> <span class="va">risk_variables</span>,</span>
<span>                          k_anonymity <span class="op">=</span> <span class="va">k_anonymity</span>,</span>
<span>                          swaprate <span class="op">=</span> <span class="va">swaprate</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Recordswapping was successful!</span></span></code></pre>
<p>Please note that the underlying <code>c++</code>-routines expect indices starting from 0 but in <code>R</code> indices start with 1. The wrapper function <code><a href="../reference/recordSwap.html">recordSwap()</a></code> converts indices or column names in <code>R</code> into the correct format for the <code>c++</code> routines. So using column indices for this function call should be done in the usually <code>R</code>-fashion where indices start with 1.</p>
</div>
<div class="section level3">
<h3 id="similarity-profiles">Similarity profiles<a class="anchor" aria-label="anchor" href="#similarity-profiles"></a>
</h3>
<p>In some cases, the condition of finding a <em>similar</em> household given by the parameter <code>similarity</code> might be too strict. And thus, it is not possible to swap the necessary number of households due to the lack of a suitable donor household.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># demonstrate on small data set</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/recordSwap.html">createDat</a></span><span class="op">(</span>N<span class="op">=</span><span class="fl">10000</span><span class="op">)</span></span>
<span><span class="va">hierarchy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"nuts1"</span>,<span class="st">"nuts2"</span><span class="op">)</span></span>
<span><span class="va">risk_variables</span> <span class="op">&lt;-</span> <span class="st">"gender"</span></span>
<span><span class="co"># similarity profile contains:</span></span>
<span><span class="co"># nuts1 + hsize + htype + hincome</span></span>
<span><span class="va">similar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"nuts1"</span>,<span class="st">"hsize"</span>,<span class="st">"htype"</span>,<span class="st">"hincome"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># procedure will not always find a suitable donor</span></span>
<span><span class="va">dat_swapped</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/recordSwap.html">recordSwap</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">dat</span>, hid <span class="op">=</span> <span class="va">hid</span>,</span>
<span>                          hierarchy <span class="op">=</span> <span class="va">hierarchy</span>,</span>
<span>                          similar <span class="op">=</span> <span class="va">similar</span>,</span>
<span>                          risk_variables <span class="op">=</span> <span class="va">risk_variables</span>,</span>
<span>                          k_anonymity <span class="op">=</span> <span class="fl">3</span>,</span>
<span>                          swaprate <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>                          seed <span class="op">=</span> <span class="fl">123456L</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Donor household was not found in 3 case(s).</span></span>
<span><span class="co">## See TRS_logfile.txt for a detailed list</span></span></code></pre>
<p>The expected number of swapped households for a population of 10000 households and a swapping rate of 0.05 is 500. The actual number of swaps was however:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat_compare</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">dat</span><span class="op">[</span>,<span class="fu">.</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">nuts1</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="va">nuts2</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,by<span class="op">=</span><span class="va">hid</span><span class="op">]</span>,</span>
<span>                     <span class="va">dat_swapped</span><span class="op">[</span>,<span class="fu">.</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">nuts1</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="va">nuts2</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,by<span class="op">=</span><span class="va">hid</span><span class="op">]</span>,by<span class="op">=</span><span class="st">"hid"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># number of swapped households</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">dat_compare</span><span class="op">[</span><span class="va">V1.x</span><span class="op">!=</span><span class="va">V1.y</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 494</span></span></code></pre>
<p>With the parameter <code>similar</code> multiple similarity profiles can be defined, if the parameter input is a <code>list</code>. If a donor could not be found for the first similarity profile (<code>similar[[1]]</code>) then a donor is searched for using the next similarity profile (<code>similar[[2]]</code>) and so on.</p>
<p>Using multiple similarity profiles makes it easy to supply fall-back profiles if the initial profile is too specific.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># additional profile contains only hsize</span></span>
<span><span class="va">similar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">similar</span><span class="op">)</span></span>
<span><span class="va">similar</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"hsize"</span></span>
<span><span class="va">similar</span></span></code></pre></div>
<pre><code><span><span class="co">## [[1]]</span></span>
<span><span class="co">## [1] "nuts1"   "hsize"   "htype"   "hincome"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [[2]]</span></span>
<span><span class="co">## [1] "hsize"</span></span></code></pre>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># procedure found donors for every record</span></span>
<span><span class="va">dat_swapped</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/recordSwap.html">recordSwap</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">dat</span>, hid <span class="op">=</span> <span class="va">hid</span>,</span>
<span>                          hierarchy <span class="op">=</span> <span class="va">hierarchy</span>,</span>
<span>                          similar <span class="op">=</span> <span class="va">similar</span>,</span>
<span>                          risk_variables <span class="op">=</span> <span class="va">risk_variables</span>,</span>
<span>                          k_anonymity <span class="op">=</span> <span class="fl">3</span>,</span>
<span>                          swaprate <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>                          seed <span class="op">=</span> <span class="fl">123456L</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Recordswapping was successful!</span></span></code></pre>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat_compare</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">dat</span><span class="op">[</span>,<span class="fu">.</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">nuts1</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="va">nuts2</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,by<span class="op">=</span><span class="va">hid</span><span class="op">]</span>,</span>
<span>                     <span class="va">dat_swapped</span><span class="op">[</span>,<span class="fu">.</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">nuts1</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="va">nuts2</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,by<span class="op">=</span><span class="va">hid</span><span class="op">]</span>,by<span class="op">=</span><span class="st">"hid"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># number of swapped households</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">dat_compare</span><span class="op">[</span><span class="va">V1.x</span><span class="op">!=</span><span class="va">V1.y</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 500</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="carry-along-variables">Carry along variables<a class="anchor" aria-label="anchor" href="#carry-along-variables"></a>
</h3>
<p>Using the function <code><a href="../reference/recordSwap.html">recordSwap()</a></code> like above always results in swapping the variables defined through variable <code>hierarchy</code>. Sometimes it might be useful to swap more variables than the ones stated in hierarchy.</p>
<p>When we apply the record swapping using <code>hierarchy</code>-levels <code>nuts1</code> and <code>nuts2</code> then the <code>nuts3</code> and <code>lau2</code>-variable in our data set will stay unchanged. Thus for the resulting data set, the variables <code>nuts1</code> and <code>nuts2</code> are no longer coherent with <code>nuts3</code> and <code>lau2</code>.</p>
<p>Letâ€™s have a more detailed look at the problem</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hid</span> <span class="op">&lt;-</span> <span class="st">"hid"</span></span>
<span><span class="va">hierarchy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"nuts1"</span>,<span class="st">"nuts2"</span><span class="op">)</span></span>
<span><span class="va">similar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hsize"</span><span class="op">)</span></span>
<span><span class="va">risk_variables</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hincome"</span>,<span class="st">"htype"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dat_swapped</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/recordSwap.html">recordSwap</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/copy.html" class="external-link">copy</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span>,</span>
<span>                        hid <span class="op">=</span> <span class="va">hid</span>,</span>
<span>                        hierarchy <span class="op">=</span> <span class="va">hierarchy</span>,</span>
<span>                        similar <span class="op">=</span> <span class="va">similar</span>,</span>
<span>                        risk_variables <span class="op">=</span> <span class="va">risk_variables</span>,</span>
<span>                        swaprate <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>                        seed<span class="op">=</span><span class="fl">1234L</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Recordswapping was successful!</span></span></code></pre>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># compare results</span></span>
<span><span class="va">dat_compare</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">dat</span><span class="op">[</span>,<span class="fu">.</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">nuts1</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="va">nuts2</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,by<span class="op">=</span><span class="va">hid</span><span class="op">]</span>,</span>
<span>                     <span class="va">dat_swapped</span><span class="op">[</span>,<span class="fu">.</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">nuts1</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="va">nuts2</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,by<span class="op">=</span><span class="va">hid</span><span class="op">]</span>,by<span class="op">=</span><span class="st">"hid"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">dat_compare</span><span class="op">[</span><span class="va">V1.x</span><span class="op">!=</span><span class="va">V1.y</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    hid V1.x V1.y</span></span>
<span><span class="co">## 1:   5 2 21 3 35</span></span>
<span><span class="co">## 2:  30 3 32 3 31</span></span>
<span><span class="co">## 3:  37 1 13 2 24</span></span>
<span><span class="co">## 4:  55 2 24 3 33</span></span>
<span><span class="co">## 5:  84 2 25 2 21</span></span>
<span><span class="co">## 6:  85 1 13 2 22</span></span></code></pre>
<p>For <code>nuts1==1</code> and <code>nuts2==14</code> the <code>nuts3</code> variables takes on values</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat</span><span class="op">[</span><span class="va">nuts1</span><span class="op">==</span><span class="fl">1</span><span class="op">&amp;</span><span class="va">nuts2</span><span class="op">==</span><span class="fl">14</span>,<span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">nuts3</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] 1401 1402 1403 1404 1405 1406 1407 1408 1409 1410 1411 1412 1413 1414 1415</span></span></code></pre>
<p>In the swapped data set there are however many more values for <code>nuts3</code> now which are not coherent with <code>nuts1==1</code> and <code>nuts2==14</code></p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat_swapped</span><span class="op">[</span><span class="va">nuts1</span><span class="op">==</span><span class="fl">1</span><span class="op">&amp;</span><span class="va">nuts2</span><span class="op">==</span><span class="fl">14</span>,<span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">nuts3</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] 1106 1109 1201 1213 1306 1308 1309 1310 1314 1401 1402 1403 1404 1405 1406</span></span>
<span><span class="co">## [16] 1407 1408 1409 1410 1411 1412 1413 1414 1415 1503 1510 1513 2101 2106 2209</span></span>
<span><span class="co">## [31] 2303 2310 2311 2507 2511 3104 3202 3206 3212 3315 3403 3408 3410 3505 3510</span></span>
<span><span class="co">## [46] 3511 3513 3514</span></span></code></pre>
<p>Using the parameter <code>carry_along</code> one can define certain variables which are additionally swapped but do not interfere with the risk calculation, sampling and procedure of finding a donor.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat_swapped2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/recordSwap.html">recordSwap</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/copy.html" class="external-link">copy</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span>,</span>
<span>                        hid <span class="op">=</span> <span class="va">hid</span>,</span>
<span>                        hierarchy <span class="op">=</span> <span class="va">hierarchy</span>,</span>
<span>                        similar <span class="op">=</span> <span class="va">similar</span>,</span>
<span>                        risk_variables <span class="op">=</span> <span class="va">risk_variables</span>,</span>
<span>                        swaprate <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>                        carry_along <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"nuts3"</span>,<span class="st">"lau2"</span><span class="op">)</span>, <span class="co"># &lt;- swap nuts3 and lau2 variable as well</span></span>
<span>                        seed<span class="op">=</span><span class="fl">1234L</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Recordswapping was successful!</span></span></code></pre>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">geoVars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"nuts1"</span>, <span class="st">"nuts2"</span>, <span class="st">"nuts3"</span><span class="op">)</span></span>
<span><span class="va">dat_geo</span> <span class="op">&lt;-</span> <span class="va">dat</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html" class="external-link">duplicated</a></span><span class="op">(</span><span class="va">hid</span><span class="op">)</span>,<span class="va">..geoVars</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setorder.html" class="external-link">setorderv</a></span><span class="op">(</span><span class="va">dat_geo</span>,<span class="va">geoVars</span><span class="op">)</span></span>
<span><span class="va">dat_geo_swapped</span> <span class="op">&lt;-</span> <span class="va">dat_swapped2</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html" class="external-link">duplicated</a></span><span class="op">(</span><span class="va">hid</span><span class="op">)</span>,<span class="va">..geoVars</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setorder.html" class="external-link">setorderv</a></span><span class="op">(</span><span class="va">dat_geo_swapped</span>,<span class="va">geoVars</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># check if value combinations of swapped and original data are the same</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">dat_geo</span>,<span class="va">dat_geo_swapped</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] TRUE</span></span></code></pre>
<p>Both the original and swapped data set have the same value combinations for <code>nuts1</code>, <code>nuts2</code> and <code>nuts3</code>. Setting this parameter did, however, not interfere with the swapping procedure</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat_compare2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">dat</span><span class="op">[</span>,<span class="fu">.</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">nuts1</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="va">nuts2</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,by<span class="op">=</span><span class="va">hid</span><span class="op">]</span>,</span>
<span>                     <span class="va">dat_swapped</span><span class="op">[</span>,<span class="fu">.</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">nuts1</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="va">nuts2</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,by<span class="op">=</span><span class="va">hid</span><span class="op">]</span>,by<span class="op">=</span><span class="st">"hid"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># check if same hid were swapped in both cases</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">dat_compare2</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">hid</span><span class="op">)</span>,<span class="fu">.</span><span class="op">(</span><span class="va">hid</span><span class="op">)</span><span class="op">]</span>,</span>
<span>          <span class="va">dat_compare</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">hid</span><span class="op">)</span>,<span class="fu">.</span><span class="op">(</span><span class="va">hid</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] TRUE</span></span></code></pre>
<p>Using the same idea one can set <code>return_swapped_id = TRUE</code> to return the <code>hid</code> with which the records were swapped with.</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat_swapped3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/recordSwap.html">recordSwap</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/copy.html" class="external-link">copy</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span>,</span>
<span>                        hid <span class="op">=</span> <span class="va">hid</span>,</span>
<span>                        hierarchy <span class="op">=</span> <span class="va">hierarchy</span>,</span>
<span>                        similar <span class="op">=</span> <span class="va">similar</span>,</span>
<span>                        risk_variables <span class="op">=</span> <span class="va">risk_variables</span>,</span>
<span>                        swaprate <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>                        carry_along <span class="op">=</span> <span class="st">"nuts3"</span>,</span>
<span>                        return_swapped_id <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                        seed<span class="op">=</span><span class="fl">1234L</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Recordswapping was successful!</span></span></code></pre>
<p>The output now has an additional column named <code>hid_swapped</code>, which contains the household ID with which a household was swapped with.</p>
<p>Number of swapped <code>hid</code>s</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat_swapped3</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html" class="external-link">duplicated</a></span><span class="op">(</span><span class="va">hid</span><span class="op">)</span>,<span class="va">.N</span>,by<span class="op">=</span><span class="fu">.</span><span class="op">(</span>id_swapped <span class="op">=</span> <span class="va">hid</span><span class="op">!=</span><span class="va">hid_swapped</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##    id_swapped    N</span></span>
<span><span class="co">## 1:      FALSE 9500</span></span>
<span><span class="co">## 2:       TRUE  500</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="information-loss">Information loss<a class="anchor" aria-label="anchor" href="#information-loss"></a>
</h3>
<p>With the function <code><a href="../reference/infoLoss.html">infoLoss()</a></code> one can calculate various information loss measures over a pre defined frequency table. This frequency table is defined by the parameter <code>table_vars</code>, which accepts column names of the original and swapped micro data. The frequency table is internally constructed using both the original and swapped micro data. Afterwards, various information loss measures are estimated over each of the table cells.</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># calculate information loss for frequecy table nuts2 x national</span></span>
<span><span class="va">table_vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"nuts2"</span>,<span class="st">"national"</span><span class="op">)</span></span>
<span><span class="va">iloss</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/infoLoss.html">infoLoss</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">dat</span>, data_swapped <span class="op">=</span> <span class="va">dat_swapped3</span>,</span>
<span>                  table_vars <span class="op">=</span> <span class="va">table_vars</span><span class="op">)</span></span>
<span><span class="va">iloss</span><span class="op">$</span><span class="va">measures</span></span></code></pre></div>
<pre><code><span><span class="co">##       what      absD   abssqrtD     relabsD</span></span>
<span><span class="co">##  1:    Min  0.000000 0.00000000 0.000000000</span></span>
<span><span class="co">##  2:    10%  0.000000 0.00000000 0.000000000</span></span>
<span><span class="co">##  3:    20%  0.000000 0.00000000 0.000000000</span></span>
<span><span class="co">##  4:    30%  1.000000 0.02259307 0.002040790</span></span>
<span><span class="co">##  5:    40%  2.000000 0.04539935 0.004127633</span></span>
<span><span class="co">##  6:   Mean  4.189474 0.09770938 0.009125583</span></span>
<span><span class="co">##  7: Median  4.000000 0.08882329 0.007858546</span></span>
<span><span class="co">##  8:    60%  5.000000 0.11570289 0.010699793</span></span>
<span><span class="co">##  9:    70%  6.000000 0.14137119 0.013269704</span></span>
<span><span class="co">## 10:    80%  7.200000 0.17053767 0.016089598</span></span>
<span><span class="co">## 11:    90%  9.600000 0.22252666 0.020964043</span></span>
<span><span class="co">## 12:    95% 12.000000 0.28374237 0.026711869</span></span>
<span><span class="co">## 13:    99% 15.120000 0.33674859 0.030239189</span></span>
<span><span class="co">## 14:    Max 17.000000 0.39654707 0.036324786</span></span></code></pre>
<p>Per default the absolute deviation (<span class="math inline">\(abs(x,y)\)</span>), relative absolute deviation (<span class="math inline">\(r\_abs(x,y)\)</span>), and absolute deviaion of square roots (<span class="math inline">\(abs\_sqr(x,y)\)</span>) is calculated between the table cells x and y, see also parameter <code>metric</code>.</p>
<p><span class="math display">\[
abs(x,y) = |x-y| 
\]</span></p>
<p><span class="math display">\[
r\_abs(x,y) = \frac{|x-y|}{x}
\]</span></p>
<p><span class="math display">\[
abs\_sqr(x,y) = |\sqrt{x}-\sqrt{y}|
\]</span></p>
<p>It is also possible to supply a custom information loss metric by using parameter <code>custom_meric</code></p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># define squared distance as custom metric</span></span>
<span><span class="va">squareD</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>,<span class="va">y</span><span class="op">)</span><span class="op">{</span></span>
<span>   <span class="op">(</span><span class="va">x</span><span class="op">-</span><span class="va">y</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">iloss</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/infoLoss.html">infoLoss</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">dat</span>, data_swapped <span class="op">=</span> <span class="va">dat_swapped3</span>,</span>
<span>                  table_vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"nuts2"</span>,<span class="st">"national"</span><span class="op">)</span>,</span>
<span>                  custom_metric <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>squareD<span class="op">=</span><span class="va">squareD</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">iloss</span><span class="op">$</span><span class="va">measures</span> <span class="co"># includes custom loss as well</span></span></code></pre></div>
<pre><code><span><span class="co">##       what      absD   abssqrtD     relabsD   squareD</span></span>
<span><span class="co">##  1:    Min  0.000000 0.00000000 0.000000000   0.00000</span></span>
<span><span class="co">##  2:    10%  0.000000 0.00000000 0.000000000   0.00000</span></span>
<span><span class="co">##  3:    20%  0.000000 0.00000000 0.000000000   0.00000</span></span>
<span><span class="co">##  4:    30%  1.000000 0.02259307 0.002040790   1.00000</span></span>
<span><span class="co">##  5:    40%  2.000000 0.04539935 0.004127633   4.00000</span></span>
<span><span class="co">##  6:   Mean  4.189474 0.09770938 0.009125583  33.55789</span></span>
<span><span class="co">##  7: Median  4.000000 0.08882329 0.007858546  16.00000</span></span>
<span><span class="co">##  8:    60%  5.000000 0.11570289 0.010699793  25.00000</span></span>
<span><span class="co">##  9:    70%  6.000000 0.14137119 0.013269704  36.00000</span></span>
<span><span class="co">## 10:    80%  7.200000 0.17053767 0.016089598  52.00000</span></span>
<span><span class="co">## 11:    90%  9.600000 0.22252666 0.020964043  92.40000</span></span>
<span><span class="co">## 12:    95% 12.000000 0.28374237 0.026711869 144.00000</span></span>
<span><span class="co">## 13:    99% 15.120000 0.33674859 0.030239189 228.84000</span></span>
<span><span class="co">## 14:    Max 17.000000 0.39654707 0.036324786 289.00000</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="sdcmicro-objects">sdcMicro Objects<a class="anchor" aria-label="anchor" href="#sdcmicro-objects"></a>
</h3>
<p>The function <code><a href="../reference/recordSwap.html">recordSwap()</a></code> can be called using the micro data directly, as seen above, or with an sdcMicro-Object. Parameters for the swapping routine can be passed to the options-slot when creating the sdcMicro-Object.</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># define paramters</span></span>
<span><span class="va">hierarchy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"nuts1"</span>,<span class="st">"nuts2"</span><span class="op">)</span></span>
<span><span class="va">risk_variables</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hincome"</span>,<span class="st">"ageGroup"</span>,<span class="st">"gender"</span><span class="op">)</span></span>
<span><span class="va">k_anonymity</span> <span class="op">&lt;-</span> <span class="fl">3</span></span>
<span><span class="va">swaprate</span> <span class="op">&lt;-</span> <span class="fl">.05</span></span>
<span><span class="va">hid</span> <span class="op">&lt;-</span> <span class="st">"hid"</span></span>
<span><span class="va">similar</span> <span class="op">&lt;-</span> <span class="st">"hsize"</span></span>
<span></span>
<span><span class="co"># create sdcMicro object with parameters for recordSwap()</span></span>
<span><span class="va">data_sdc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdcMicroObj-class.html">createSdcObj</a></span><span class="op">(</span><span class="va">dat</span>,hhId <span class="op">=</span> <span class="va">hid</span>,</span>
<span>                         keyVars<span class="op">=</span><span class="va">risk_variables</span>,</span>
<span>                         options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>k_anonymity <span class="op">=</span> <span class="va">k_anonymity</span>,</span>
<span>                                                    swaprate <span class="op">=</span> <span class="va">swaprate</span>,</span>
<span>                                                    similar <span class="op">=</span> <span class="va">similar</span>,</span>
<span>                                                    hierarchy <span class="op">=</span> <span class="va">hierarchy</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat_swapped_sdc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/recordSwap.html">recordSwap</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">data_sdc</span>,</span>
<span>                              return_swapped_id <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Recordswapping was successful!</span></span></code></pre>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat_swapped_sdc</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html" class="external-link">duplicated</a></span><span class="op">(</span><span class="va">hid</span><span class="op">)</span>,<span class="va">.N</span>,by<span class="op">=</span><span class="fu">.</span><span class="op">(</span>id_swapped <span class="op">=</span> <span class="va">hid</span><span class="op">!=</span><span class="va">hid_swapped</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##    id_swapped    N</span></span>
<span><span class="co">## 1:      FALSE 9500</span></span>
<span><span class="co">## 2:       TRUE  500</span></span></code></pre>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Matthias Templ, Bernhard Meindl, Alexander Kowarik, Johannes Gussenbauer.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
